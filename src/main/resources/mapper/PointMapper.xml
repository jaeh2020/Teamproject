<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="amdn.anywhere.mapper.PointMapper">
	<resultMap type="Point" id="pointResultMap">
		<result property="pointNum" column="point_num"/>
		<result property="userId" column="user_id"/>
		<result property="oTotal" column="o_total"/>
		<result property="pointSave" column="point_save"/>
		<result property="pointContents" column="point_contents"/>
		<result property="pointSaveTime" column="point_save_time"/>
		<result property="pointAdd" column="point_add"/>
		<result property="beforePointHistory" column="before_point_history"/>
		<result property="afterPointHistory" column="after_point_history"/>
		<result property="predDelTime" column="pred_del_time"/>		
		<association property="pointDel" javaType="PointDel">
			<id property="pointNum" column="point_num"/>
			<result property="pointDelNum" column="point_del_num"/>
			<result property="userId" column="user_id"/>
			<result property="pointDelTime" column="po_del_time"/>
			<result property="delPoint" column="del_point"/>
			<result property="remainPoint" column="remain_point"/>
			<result property="pointDelContents" column="point_del_contents"/>
		</association>
	</resultMap>

	<!-- 포인트 소멸 -->
	<insert id="addPointDel">
		INSERT INTO tb_point_del
			(point_del_num
			, user_id
			, point_num
			, point_del_time
			, point_del_contents
			, del_point
			, remain_point
		)VALUES (
			#{pointDelNum}
			, #{userId}
			, (SELECT
						point_num
					FROM
						tb_point
					WHERE
						user_id = #{userId} AND DATE_FORMAT(pred_del_time, "%Y-%m-%d") = CURDATE())
			, NOW()
			, '소멸'
			, (SELECT
						point_add
					FROM
						tb_point
					WHERE
						user_id = #{userId} AND DATE_FORMAT(pred_del_time, "%Y-%m-%d") = CURDATE())
			, (SELECT
					after_point_history
				FROM
					tb_point
				WHERE
					user_id = #{userId}
				ORDER BY
					point_save_time DESC LIMIT 1) - del_point);
	</insert>
	
	
	<!-- 소멸시간 찾기~ -->
	<select id="pointDelTime" resultType="String">
		SELECT
			DATE_FORMAT(pred_del_time, "%Y-%m-%d")
		FROM
			tb_point
		WHERE
			user_id = #{userId} AND DATE_FORMAT(pred_del_time, "%Y-%m-%d") = CURDATE();
	</select>
	
	
	<!-- 포인트 소멸코드 자동증가 -->
	<select id="getPointDelCode" resultType="String">
		SELECT
		CASE
		WHEN COUNT(1) = 0 THEN 'p_del_001'
		ELSE
			CONCAT('p_del_', LPAD(MAX(CAST(SUBSTRING(point_del_num,7,3)AS DECIMAL)+1),3,0))
		END AS pointDelNum
		FROM
			tb_point_del;
	</select>
	
	<!-- 포인트 적립 -->
	<insert id="addPoint">
		INSERT INTO tb_point
			(point_num
			, user_id
			, o_total
			, point_save
			, point_contents
			, point_save_time
			, point_add
			, before_point_history
			, after_point_history
			, pred_del_time
		)VALUES (
			  #{pointNum}
			, #{userId}
			, #{oTotal}
			, 1
			, '주문 적립'
			, NOW()
			, (o_total/100)
			, ( SELECT p.after_point_history AS '이전 포인트' 
				FROM tb_point AS p 
				WHERE p.point_num = (SELECT
										CASE
										WHEN COUNT(1) = 0 THEN 'p_001'
										ELSE
										CONCAT('p_', LPAD(MAX(CAST(SUBSTRING(p.point_num,3,3)AS DECIMAL)),3,0))
										END AS pointNum
									 FROM
										tb_point as p
									 WHERE
										user_id = #{userId}))
			, (point_add + before_point_history)
			, DATE_ADD(point_save_time, INTERVAL 90 DAY))
	</insert>
	
	<!-- 가입 시 포인트 적립 -->
	<insert id="addJoinPoint">
		INSERT INTO tb_point
			(point_num
			, user_id
			, o_total
			, point_save
			, point_contents
			, point_save_time
			, point_add
			, before_point_history
			, after_point_history
			, pred_del_time
		)VALUES (
			  #{pointNum}
			, #{userId}
			, #{oTotal}
			, #{pointSave}
			, #{pointContents}
			, NOW()
			, #{pointAdd}
			, #{beforePointHistory}
			, #{afterPointHistory}
			, DATE_ADD(point_save_time, INTERVAL 90 DAY))
	</insert>
	
	<!-- 포인트 적립코드 자동증가 -->
	<select id="getPointCode" resultType="String">
		SELECT
		CASE
		WHEN COUNT(1) = 0 THEN 'p_001'
		ELSE
			CONCAT('p_', LPAD(MAX(CAST(SUBSTRING(point_num,3,3)AS DECIMAL)+1),3,0))
		END AS pointNum
		FROM
			tb_point;
	</select>
	
	<!-- 포인트적립 개인조회 -->
	<select id="getPointListInfoById" resultMap="pointResultMap">
		SELECT 
			  p.point_num
			, p.user_id
			, p.o_total
			, p.point_save
			, p.point_contents
			, p.point_save_time
			, p.point_add
			, p.before_point_history
			, p.after_point_history
			, p.pred_del_time
			, d.point_del_num
			, d.user_id
			, d.point_num
			, d.point_del_time
			, d.del_point
			, d.remain_point
			, d.point_del_contents
		FROM 
			tb_point as p
			LEFT JOIN
			tb_point_del as d
			ON
			p.point_num = d.point_num
		WHERE
			p.user_id = #{userId}
		ORDER BY
			p.point_save_time DESC;
	</select>
	
	<!-- 포인트 적립 전체 조회  -->
	<select id="getPointList" resultMap="pointResultMap">
		SELECT 
			  p.point_num
			, p.user_id
			, p.o_total
			, p.point_save
			, p.point_contents
			, p.point_save_time
			, p.point_add
			, p.before_point_history
			, p.after_point_history
			, p.pred_del_time
			, d.point_del_num
			, d.user_id
			, d.point_num
			, d.point_del_time
			, d.del_point
			, d.remain_point
			, d.point_del_contents
		FROM 
			tb_point as p
			LEFT JOIN
			tb_point_del as d
			ON
			p.point_num = d.point_num;
	</select>
</mapper>