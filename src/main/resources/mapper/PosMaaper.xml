<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="amdn.anywhere.mapper.PosMapper">

	<resultMap type="Order" id="orderResultMap">
		<result property="oCode"				column="o_code"/>
		<result property="bookCode"				column="b_o_code"/>
		<result property="userId"				column="user_id"/>
		<result property="storeCode"			column="store_code"/>
		<result property="menuCode"				column="menu_code"/>
		<result property="oCount"				column="o_count"/>
		<result property="menuTotalPrice"		column="menu_total_price"/>
		<result property="oRequest"				column="o_request"/>
		<result property="payGroCode"			column="pay_gro_code"/>
		<result property="oTotalPrice"			column="o_total_price"/>
		<result property="orderSignTime"		column="order_sign_time"/>
		<result property="orderCompTime"		column="order_comp_time"/>
		<result property="orderStateCode"		column="order_state_code"/>
		<result property="storeTableCode"		column="store_table_code"/>
		<association property="book" javaType="Book">
			<id property="bookCode" 			column="b_o_code"/>
			<result property="storeCode"		column="store_code"/>
			<result property="userId"			column="user_id"/>
			<result property="bookUserName"		column="book_user_name"/>
			<result property="bookUserPhone"	column="book_user_phone"/>
			<result property="bookPeoNum"		column="book_peo_num"/>
			<result property="bookSignTime"		column="book_sign_time"/>
			<result property="bookCompTime"		column="book_comp_time"/>
			<result property="bookCallAgree"	column="book_call_agree"/>
			<result property="stateCode"		column="state_code"/>
			<result property="bookPickup"		column="book_pickup"/>
		</association>
		<association property="store" javaType="Store">
			<id property="storeCode" 			column="store_code"/>
			<result property="storeCode"		column="store_code"/>
			<result property="storeName"		column="store_name"/>
			<result property="bizCode"			column="biz_code"/>
			<result property="bizId"			column="biz_id"/>
			<result property="storeLocation"	column="store_location"/>
			<result property="storeTime"		column="store_time"/>
			<result property="storePhone"		column="store_phone"/>
			<result property="mainCateCode"		column="main_cate_code"/>
			<result property="mainCateCode2"	column="main_cate_code2"/>
			<result property="storeHoliday"		column="store_holiday"/>
			<result property="storeTasteAgree"	column="store_taste_agree"/>
			<result property="storeExposAgree"	column="store_expos_agree"/>
			<result property="storePhoto"		column="store_photo"/>
			<result property="storeTableNum"	column="store_table_num"/>
			<result property="storeOccupancy"	column="store_occupancy"/>
		</association>
		<association property="statement" javaType="Statement">
			<id property="stateCode" 			column="state_code"/>
			<result property="mainState"		column="main_state"/>
			<result property="stateName"		column="state_name"/>
		</association>
		<association property="menu" 	javaType="Menu">
			<id property="menuCode" 			column="menu_code"/>
			<result property="bizId"			column="biz_id"/>
			<result property="storeCode"		column="store_code"/>
			<result property="mainCateCode"		column="main_cate_code"/>
			<result property="menuCateCode"		column="menu_cate_code"/>
			<result property="menuName"			column="menu_name"/>
			<result property="menuPrice"		column="menu_price"/>
			<result property="menuDetail"		column="menu_detail"/>
			<result property="menuRegTime"		column="menu_reg_time"/>
			<result property="menuUsing"		column="menu_using"/>
		</association>
	</resultMap>
	
	<resultMap type="Statement" id="statementResultMap">
		<result property="stateCode"			column="state_code"/>
		<result property="mainState"			column="main_state"/>
		<result property="stateName"			column="state_name"/>
			<association property="order" 	javaType="Order">
			<id property="oCode" 					column="o_code"/>
			<result property="bookCode"				column="b_o_code"/>
			<result property="userId"				column="user_id"/>
			<result property="storeCode"			column="store_code"/>
			<result property="menuCode"				column="menu_code"/>
			<result property="oCount"				column="o_count"/>
			<result property="menuTotalPrice"		column="menu_total_price"/>
			<result property="oRequest"				column="o_request"/>
			<result property="payGroCode"			column="pay_gro_code"/>
			<result property="oTotalPrice"			column="o_total_price"/>
			<result property="orderSignTime"		column="order_sign_time"/>
			<result property="orderCompTime"		column="order_comp_time"/>
			<result property="orderStateCode"		column="order_state_code"/>
			<result property="storeTableCode"		column="store_table_code"/>
			</association>
	</resultMap>
	
	<resultMap type="Table" id="tableMap">
		<result property="storeTableCode"			column="store_table_code"/>
		<result property="storeCode"				column="store_code"/>
		<result property="bizId"					column="biz_id"/>
		<result property="tableNum"					column="table_num"/>
		<result property="tableStateCode"			column="table_state_code"/>
			<association property="statement" javaType="Statement">
			<id property="stateCode" 			column="state_code"/>
			<result property="mainState"		column="main_state"/>
			<result property="stateName"		column="state_name"/>
			</association>
	</resultMap>
	
	<resultMap type="Waiting" id="waitingMap">
		<result property="storeWait"	column="store_wait"/>
		<result property="storeCode"	column="store_code"/>
		<result property="bizId"		column="biz_id"/>
		<result property="stoUseTab"	column="sto_use_tab"/>
		<result property="stoEmpTab"	column="sto_emp_tab"/>
		<result property="waitNum"		column="wait_num"/>
	</resultMap>
	
	<resultMap type="Standby" id="standbyMap">
		<result property="bookStandbyCode"	column="book_standby_code"/>
		<result property="bookCode"			column="b_o_code"/>
		<result property="userId"			column="user_id"/>
		<result property="storeCode"		column="store_code"/>
		<result property="waitTime"			column="wait_time"/>
		<result property="stateCode"		column="state_code"/>
		<result property="waitCompTime"		column="wait_comp_time"/>
			<association property="statement" javaType="Statement">
			<id property="stateCode" 			column="state_code"/>
			<result property="mainState"		column="main_state"/>
			<result property="stateName"		column="state_name"/>
			</association>
	</resultMap>
	
	
	<!-- table update -->
	<update id="modifyPosTable" parameterType="map">
		UPDATE tb_store_table
			set
			<if test="tableStateName == '사용중' ">	
			table_state_code = 'state_table_using'
			</if>
			<if test="tableStateName == '정리중' ">
			table_state_code = 'state_table_clearing'
			</if>
			<if test="tableStateName == '사용가능' ">
			table_state_code = 'state_table_com'
			</if>
		WHERE
			store_table_code = #{storeTableCode};
	</update>
	
	
	
	<!-- standby테이블 상태=주문완료, 완료일시, 총대기시간 update -->
	<update id="modifyPosStanbyState" parameterType="map">
		UPDATE tb_store_standby
			set
			state_code = 'state_book_com'
			,wait_comp_time = CURTIME()
		WHERE
			b_o_code = #{bookCode};
	</update>
	
	
	
	
	<!-- waiting테이블 입장대기인원 update -->
	<update id="modifyWaitingNum" parameterType="map">
		UPDATE tb_store_waiting
			SET
			<if test="state == '웨이팅승인' ">
			wait_num = wait_num + 1
			</if>
			<if test="state == '입장완료' ">
			wait_num = wait_num - 1
			</if>
			<if test="tableStateName == '사용중' ">
			sto_use_tab = sto_use_tab + 1
			,sto_emp_tab = sto_emp_tab - 1
			</if>
			<if test="tableStateName == '사용가능' ">
			sto_use_tab = sto_use_tab - 1
			,sto_emp_tab = sto_emp_tab + 1
			</if>
			<if test="tableStateName == '정리중' ">
			sto_use_tab = sto_use_tab + 0
			</if>
		WHERE
			store_code = #{storeCode};
	
	</update>
	
	
	<!-- 웨이팅소비자목록조회-standby -->
	<select id="getPosStandby" resultMap="standbyMap">
		SELECT
			w.book_standby_code
			,w.b_o_code
			,w.user_id
			,w.store_code
			,w.wait_time
			,w.state_code
			,w.wait_comp_time
			,s.state_name
		FROM
			tb_store_standby AS w
			INNER join
			tb_statement AS s
			on
			w.state_code = s.state_code
		WHERE
			store_code = #{storeCode};
	</select>
	
	
	
	<!-- 웨이팅승인시 standby테이블 insert -->
	<insert id="addPosStandby" parameterType="map">
		INSERT INTO tb_store_standby
			(
			book_standby_code
			,b_o_code
			,user_id
			,store_code
			,wait_time
			,state_code
			,wait_comp_time
			)
		VALUES (
			 #{bookStandbyCode}
			, #{bookCode}
			, #{userId}
			, #{storeCode}
			, CURTIME()
			, 'state_waiting_wait'
			, NULL
		);
	</insert>
	
	
	<!-- standby코드 자동증가 -->
	<select id="getNewBookStandbyCode" resultType="String">
		SELECT
			CASE
			WHEN COUNT(1) = 0 THEN 'standby_001'
			ELSE
			CONCAT('standby_', LPAD(MAX(CAST(SUBSTRING(book_standby_code,9,3)AS DECIMAL)+1),3,0))
			END AS bookStandbyCode
		FROM
			tb_store_standby;
	</select>
	
	

	<!-- 웨이팅현황 조회 -->
	<select id="getPosWaiting" parameterType="String" resultMap="waitingMap">
		SELECT
			store_wait
			,store_code
			,biz_id
			,sto_use_tab
			,sto_emp_tab
			,wait_num
		FROM
			tb_store_waiting
		WHERE
			store_code = #{storeCode};
	</select>
	
	
	<!-- 테이블번호 변경 or 입장완료버튼 클릭시 update -->
	<update id="modifyPosTableState" parameterType="map">
		UPDATE tb_order
		SET
			store_table_code = #{storeTableCode}
		where
			b_o_code = #{bookCode};
	</update>
	
	
	
	<!-- 주문승인/웨이팅승인 클릭시 book테이블 상태변경-->
	<update id="modifyPosBookState" parameterType="map">
		UPDATE tb_book
		SET
			<if test="state == '주문승인' ">
			book_comp_time = CURTIME()
			,state_code = 'state_book_com'
			,book_call_agree = #{orderConfirmId}
			</if>
			<if test="state == '웨이팅승인' ">
			state_code = 'state_waiting_wait'
			,book_call_agree = #{orderConfirmId}
			</if>
			<if test="state == '입장완료' ">
			state_code = 'state_book_com'
			</if>
		WHERE
			b_o_code = #{bookCode};
	</update>
	
	
	
	<!-- 주문승인/웨이팅승인 클릭 or 입장완료버튼 클릭시 order테이블 상태변경 -->
	<update id="modifyPosOrderState" parameterType="map">
		UPDATE tb_order
		SET
			<if test="state == '주문승인' ">
			order_comp_time = CURTIME()
			,order_state_code = 'state_book_com'
			</if>
			<if test="state == '웨이팅승인' ">
			order_state_code = 'state_waiting_wait'
			</if>
			<if test="state == '입장완료' ">
			order_comp_time = CURTIME()
			,order_state_code = 'state_book_com'
			</if>
		WHERE
			b_o_code = #{bookCode};
	</update>
	
	
	
	<!-- 나의매장 테이블정보 조회-->
	<select id="getPosTableList" resultMap="tableMap">
		SELECT
			t.store_table_code
			,t.store_code
			,t.biz_id
			,t.table_num
			,t.table_state_code
			,s.state_name
		FROM
			tb_store_table AS t
			INNER join
			tb_statement AS s
			on
			t.table_state_code = s.state_code
		WHERE
			store_code = #{storeCode};
	</select>
	

	
	<!-- pos상태목록가져오기 -->
	<select id="getPosStateList" resultMap="statementResultMap">
	SELECT
		state_code
		,main_state
		,state_name
	FROM
		tb_statement
	WHERE
		main_state = '테이블상태';
	</select>
	
	
	
	
	
	<!-- 나의매장 주문pos list조회 -->
	<select id="getPosOrderList" resultMap="orderResultMap">
		SELECT
			o.o_code
			,o.b_o_code
			,o.user_id
			,o.store_code
			,o.menu_code
			,o.o_count
			,o.menu_total_price
			,o.o_request
			,o.pay_gro_code
			,o.o_total_price
			,o.order_sign_time
			,o.order_comp_time
			,o.order_state_code
			,o.store_table_code
			,i.store_name
			,s.state_name
			,m.menu_name
		FROM
			tb_order AS o
			INNER join
			tb_book AS b
			ON
			o.user_id = b.user_id
			INNER join
			tb_store_info AS i
			on
			o.store_code = i.store_code
			INNER join
			tb_statement AS s
			on
			o.order_state_code = s.state_code
			INNER join
			tb_store_menu AS m
			on
			o.menu_code = m.menu_code
		where
			o.store_code = #{storeCode}
		GROUP BY o.b_o_code;
	</select>
	
	
	
</mapper>