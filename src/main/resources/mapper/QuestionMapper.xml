<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="amdn.anywhere.mapper.QuestionsMapper">
	<resultMap type="QuestionCate" id="questionCateResultMap">
		<result property="cateCode" column="question_cate_code"/>
		<result property="cateName" column="cate_name"/>
		<result property="cateAddTime" column="add_time"/>
		<result property="cateAddId" column="add_id"/>
		<result property="cateUpdateTime" column="update_time"/>
		<result property="cateUpdateId" column="update_id"/>
			<collection property="questionList" ofType="Questionnaire">
				<id     property="qCode" column="question_code"/>
				<result property="qContent" column="question_content"/>
				<result property="qAddTime" column="question_add_time"/>
				<result property="qAddId" column="question_add_id"/>
				<result property="qUpdateTime" column="question_update_time"/>
				<result property="qUpdateId" column="question_update_id"/>
				<result property="qCateCode" column="question_cate_code"/>
			</collection>
	</resultMap>
	<resultMap type="Questionnaire" id="QuestionnaireResultMap">
		<result property="qCode" column="question_code"/>
		<result property="qContent" column="question_content"/>
		<result property="qAddTime" column="question_add_time"/>
		<result property="qAddId" column="question_add_id"/>
		<result property="qUpdateTime" column="question_update_time"/>
		<result property="qUpdateId" column="question_update_id"/>
		<result property="qCateCode" column="question_cate_code"/>
		<association property="questionCate" javaType="QuestionCate">
			<id     property="cateCode" column="question_cate_code"/>
			<result property="cateName" column="cate_name"/>
			<result property="cateAddTime" column="add_time"/>
			<result property="cateAddId" column="add_id"/>
			<result property="cateUpdateTime" column="update_time"/>
			<result property="cateUpdateId" column="update_id"/>
		</association>
	</resultMap>
	<select id="createQCode" parameterType="String" resultType="String">
		SELECT 
			ifnull(CONCAT(SUBSTRING_INDEX(question_cate_code,'_',-1),'_',LPAD(CAST(MAX(SUBSTRING_INDEX(question_code,'_',-1))AS DECIMAL)+1,3,0)), CONCAT(SUBSTRING_INDEX(#{cateCode},'_',-1),'_','001')) AS newCode
		FROM
			tb_questionnaire
		WHERE question_cate_code = #{cateCode}
	</select>
	<select id="selectQCate" resultMap="questionCateResultMap" parameterType="String"> 
		SELECT 
			  question_cate_code
			 ,cate_name
			 ,add_time
			 ,add_id
			 ,update_time
			 ,update_id			 
		FROM 
			tb_question_cate
		WHERE question_cate_code = #{cateCode}
				
	</select>
	
	<update id="modifyQCate" parameterType="map">
		UPDATE tb_question_cate 
			SET 
				question_cate_code = #{newCode}
				,cate_name = #{newName}
				,update_id = #{updateId}
				,update_time = NOW()
        WHERE question_cate_code= #{oldCode};
	</update>
	
	<delete id="deleteQCate" parameterType="String">
		DELETE FROM tb_question_cate WHERE question_cate_code=#{cateCode};
	</delete>
	
	<insert id="insertQuestion" parameterType="Questionnaire">
		INSERT INTO tb_questionnaire
			(	question_code
				,question_content
				,question_add_time
				,question_add_id
				,question_update_time
				,question_update_id
				,question_cate_code
			)VALUES(
				 #{qCode}
				,#{qContent}
				,NOW()
				,#{qAddId}
				,null
				,null
				,#{qCateCode}
			);		 
	</insert>
	<delete id="deleteQuestion" parameterType="String">
		DELETE FROM tb_questionnaire WHERE question_code=#{qCode};
	</delete>
	
	<insert id="addQCate" parameterType="QuestionCate">
		INSERT INTO tb_question_cate
			(	question_cate_code
				,cate_name
				,add_time
				,add_id
				,update_time
				,update_id
			)VALUES(
				 #{cateCode}
				,#{cateName}
				,NOW()
				,#{cateAddId}
				,null
				,null
			);		
	</insert>
	
	<select id="getQuestionList" resultMap="QuestionnaireResultMap" parameterType="String" >
		SELECT
			q.question_code
			,q.question_content
			,q.question_add_time
			,q.question_add_id
			,q.question_update_time
			,q.question_update_id
			,q.question_cate_code
			,c.cate_name
		FROM
			tb_questionnaire AS q
			INNER JOIN 
			tb_question_cate AS c
		ON q.question_cate_code = c.question_cate_code
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			<if test="cateCode != null">
				q.question_cate_code = #{cateCode}
			</if>			
		</trim>		
	</select>
	
	
    <select id="getQuestionCateList" resultMap="questionCateResultMap"> 
		SELECT 
			  question_cate_code
			 ,cate_name
			 ,add_time
			 ,add_id
			 ,update_time
			 ,update_id			 
		FROM 
			tb_question_cate;	
	</select>
</mapper>