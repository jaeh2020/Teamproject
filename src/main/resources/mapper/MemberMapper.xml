<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="amdn.anywhere.mapper.MemberMapper">
	<resultMap type="Member" id="memberResultMap">
		<result property="memberId" column="member_id"/>
		<result property="memberPw" column="member_pw"/>
		<result property="memberName" column="member_name"/>
		<result property="levelCode" column="level_code"/>
		<result property="memberGender" column="member_gender"/>
		<result property="memberBirth" column="member_birth"/>
		<result property="memberPhone" column="member_phone"/>
		<result property="memberEmail" column="member_email"/>
		<result property="memberRegTime" column="member_reg_time"/>
		<association property="memberLevel" javaType="MemberLevel">
			<id property="levelCode" column="level_code"/>
			<result property="levelName" column="level_Name"/>
		</association>
		<association property="memberLogin" javaType="MemberLogin">
			<id property="memberId" column="member_id"/>
			<result property="loginNum" column="login_num"/>
			<result property="levelCode" column="level_code"/>
			<result property="loginTime" column="last_login_time"/>
			<result property="logoutTime" column="last_logout_time"/>
		</association>
		
	</resultMap>

	<!-- 레벨이랑 소비자 추가정보랑 포인트랑-->
	<resultMap type="MemberUser" id="memberUserResultMap">
		<result property="userId" column="user_id"/>
		<result property="msCode" column="ms_code"/>
		<result property="userOrderTotal" column="user_order_total"/>
		<result property="userPoint" column="user_point"/>
		<result property="userEvaluator" column="user_evaluator"/>
		<result property="reportScore" column="report_accu_score"/>
		<association property="membership" javaType="Membership">
			<id property="msCode" column="ms_code"/>
			<result property="msLevel" column="ms_lev"/>
			<result property="msDis" column="ms_dis"/>
			<result property="msStandard" column="ms_standard"/>
		</association>
		<association property="memberUserLike" javaType="MemberUserLike">
			<id property="likeId" column="like_id"/>
			<result property="userLikeCode" column="user_like_code"/>
			<result property="userLikeKey1" column="user_like_key_1"/>
			<result property="userLikeKey2" column="user_like_key_2"/>
			<result property="userLikeKey3" column="user_like_key_3"/>
			<result property="userUnlikeKey1" column="user_unlike_key_1"/>
			<result property="userUnlikeKey2" column="user_unlike_key_2"/>
			<result property="userUnlikeKey3" column="user_unlike_key_3"/>
		</association>
		<association property="point" javaType="Point">
			<id property="userId" column="user_id"/>
			<result property="pointNum" column="point_num"/>
			<result property="oTotal" column="o_total"/>
			<result property="pointSave" column="point_save"/>
			<result property="pointContents" column="point_contents"/>
			<result property="pointSaveTime" column="point_save_time"/>
			<result property="pointAdd" column="point_add"/>
			<result property="beforePointHistory" column="before_point_history"/>
			<result property="afterPointHistory" column="after_point_history"/>
			<result property="predDelTime" column="pred_del_time"/>		
		</association>
		<association property="membershipDel" javaType="MembershipDel">
			<id property="userId" column="user_id"/>
			<result property="msDelCode" column="ms_del_code"/>
			<result property="delBeforeCount" column="del_before_count"/>
			<result property="delBeforeName" column="del_before_name"/>
			<result property="resetTime" column="reset_time"/>	
		</association>
	</resultMap>
	
	<resultMap type="MemberBiz" id="memberBizResultMap">
		<result property="bizCode" column="biz_code"/>
		<result property="memberId" column="member_id"/>
		<result property="bizNum" column="biz_num"/>
		<result property="bizFileAtt" column="biz_file_att"/>
		<result property="bizStatus" column="biz_status"/>
		<result property="confirmId" column="confirm_id"/>
		<result property="bizReTime" column="biz_re_time"/>
		<result property="bizCompTime" column="biz_complete_time"/>
		<association property="statement" javaType="Statement">
			<id property="stateCode" column="state_code"/>
			<result property="mainState" column="main_state"/>
			<result property="stateName" column="state_name"/>
		</association>
	</resultMap>
	
	<!-- 소상공인 평가동의 -->
	<resultMap type="BizEvalAgreeChange" id="BizEvalAgreeChangeMap">
		<result property="eAgreeCode"		column="e_agree_code"/>
		<result property="bizId"			column="biz_id"/>
		<result property="StoreCode"	column="store_code"/>
		<result property="eAgreeBefore"	column="e_agree_before"/>
		<result property="eAgreeAfter"	column="e_agree_after"/>
		<result property="eAgreeTime"	column="e_apply_time"/>
		<result property="confirmId"	column="confirm_id"/>
		<result property="eStateCode"	column="e_state_code"/>
		<result property="eConfirmTime"	column="e_confirm_time"/>
		<association property="store" 		javaType="Store">
			<id property="storeCode"			column="store_code"/>
			<result property="storeName"		column="store_name"/>
			<result property="bizCode"			column="biz_code"/>
			<result property="bizId"			column="biz_id"/>
			<result property="storeLocation"	column="store_location"/>
			<result property="storeTime"		column="store_time"/>
			<result property="storePhone"		column="store_phone"/>
			<result property="mainCateCode"		column="main_cate_code"/>
			<result property="mainCateCode2"	column="main_cate_code2"/>
			<result property="storeHoliday"		column="store_holiday"/>
			<result property="storeTasteAgree"	column="store_taste_agree"/>
			<result property="storeExposAgree"	column="store_expos_agree"/>
			<result property="storeTableNum"	column="store_table_num"/>
			<result property="storeOccupancy"	column="store_occupancy"/>
			</association>
	</resultMap>
	
	
	<!-- memberUser 포인트 업데이트(소멸되거나 사용할 때마다) -->
	<update id="modifyPointDel">
		UPDATE tb_member_user AS u INNER JOIN tb_point_del AS p ON u.user_id = p.user_id
		SET
			u.user_point = (SELECT
								remain_point
							FROM
								tb_point_del
							WHERE
								user_id = #{userId}
							ORDER BY
								point_del_time DESC LIMIT 1)
		WHERE 
			u.user_id=#{userId};
	</update>
	
	<!-- memberUser 포인트 업데이트(결제완료하면 업데이트되도록..) -->
	<update id="modifyPoint">
		UPDATE tb_member_user AS u INNER JOIN tb_point AS p ON u.user_id = p.user_id
		SET
			u.user_point = (SELECT
								after_point_history
							FROM
								tb_point
							WHERE
								user_id = #{userId}
							ORDER BY
								point_save_time DESC LIMIT 1)
		WHERE 
			u.user_id=#{userId};
	</update>
	
	<!-- 로그아웃 내역!!! -->
	<update id="modifyLogout">
		UPDATE tb_member_login
		SET
			last_logout_time = NOW()
		WHERE 
			member_id=#{memberId}
	</update>
	
	<!-- 로그인 내역 -->
	<insert id="addLogin">
		INSERT INTO tb_member_login
			(login_num
			, member_id
			, level_code
			, last_login_time
			, last_logout_time
		)VALUES (
			#{loginNum}
			, #{memberId}
			, #{levelCode}
			, NOW()
			, NOW());
	</insert>
	
	<!-- 로그인내역코드 자동증가 -->
	<select id="getLoginCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'login_001'
		   ELSE
		      CONCAT('login_', LPAD(MAX(CAST(SUBSTRING(login_num,7,3)AS DECIMAL)+1),3,0))
		   END AS loginNum
		FROM
		   tb_member_login;
	</select>
	
	<!-- 소비자 회원 탈퇴 -->
	<delete id="removeMemberUser" parameterType="String">
		DELETE 
		FROM 
			tb_member_user
		WHERE 
			user_id = #{userId};
	</delete>
	
	<!-- 전체 회원 탈퇴 -->
	<delete id="removeMember" parameterType="String">
		DELETE 
		FROM 
			tb_member 
		WHERE 
			member_id = #{memberId};
	</delete>

	<!-- 소비자 추천/비추천 수정 -->
	<update id="modifyUserLike">
		UPDATE tb_member_user_like
		<trim prefix="SET" suffixOverrides=",">
			<if test="userLikeKey1 != null and userLikeKey1 != ''.toString()">
				user_like_key_1 = #{userLikeKey1},
			</if>
			<if test="userLikeKey2 != null and userLikeKey2 != ''.toString()">
				user_like_key_2 = #{userLikeKey2},
			</if>
			<if test="userLikeKey3 != null and userLikeKey3 != ''.toString()">
				user_like_key_3 = #{userLikeKey3},
			</if>
			<if test="userUnlikeKey1 != null and userUnlikeKey1 != ''.toString()">
				user_unlike_key_1 = #{userUnlikeKey1},
			</if>
			<if test="userUnlikeKey2 != null and userUnlikeKey2 != ''.toString()">
				user_unlike_key_2 = #{userUnlikeKey2},
			</if>
			<if test="userUnlikeKey3 != null and userUnlikeKey3 != ''.toString()">
				user_unlike_key_3 = #{userUnlikeKey3},
			</if>
		</trim>
		WHERE 
			user_like_code = #{userLikeCode};
	</update>
	
	<!-- 소상공인 평가동의 승인 상태, 승인자 아이디 변경 -->
	<update id="modifyBizEvalConfirm">
		UPDATE tb_member_eval_agree_change
		<trim prefix="SET" suffixOverrides=",">
			<if test="eStateCode != null and eStateCode != ''.toString()">
				e_state_code = #{eStateCode},
			</if>
			<if test="confirmId != null and confirmId != ''.toString()">
				confirm_id = #{confirmId},
			</if>
			<if test="eConfirmTime != null and eConfirmTime != ''.toString()">
				e_confirm_time = NOW(),
			</if>
		</trim>
		WHERE
			e_agree_code = #{eAgreeCode};
	</update>
	
	<!-- 소상공인 평가 승인 신청신청!! -->
	<insert id="addEvalAgree">
		INSERT INTO tb_member_eval_agree_change
			(e_agree_code
			, biz_id
			, store_code
			, e_agree_before
			, e_agree_after
			, e_apply_time
			, confirm_id
			, e_state_code
			, e_confirm_time
		)VALUES (
			  #{eAgreeCode}
			, #{bizId}
			, #{StoreCode}
			, (	SELECT
					e_agree_after
				FROM
					tb_member_eval_agree_change
				WHERE
					biz_id = #{bizId}
				ORDER by
					e_apply_time DESC LIMIT 1)
			, #{eAgreeAfter}
			, NOW()
			, #{confirmId}
			, #{eStateCode}
			, NOW())
	</insert>
	
	<!-- 소상공인 평가 승인 신청 개인!조회(id) -->
	<select id="getBizEvalInfoById" resultMap="BizEvalAgreeChangeMap">
		SELECT
			  e.e_agree_code
			, e.biz_id
			, e.store_code
			, e.e_agree_before
			, e.e_agree_after
			, e.e_apply_time
			, e.confirm_id
			, e.e_state_code
			, e.e_confirm_time
			, s.biz_id
			, s.biz_code
			, s.store_code
			, s.store_name
			, s.store_phone
			, s.store_taste_agree
		FROM
			tb_member_eval_agree_change as e
			INNER JOIN
			tb_store_info as s
			ON
			e.store_code = s.store_code
		WHERE
			e.biz_id = #{bizId};
	</select>
	
	<!-- 소상공인 평가 승인 신청 개인!조회(code) -->
	<select id="getBizEvalInfoByCode" resultMap="BizEvalAgreeChangeMap">
		SELECT
			e_agree_code
			, biz_id
			, store_code
			, e_agree_before
			, e_agree_after
			, e_apply_time
			, confirm_id
			, e_state_code
			, e_confirm_time
		FROM
			tb_member_eval_agree_change
		WHERE
			e_agree_code = #{eAgreeCode};
	</select>
	
	<!-- 소상공인 평가 승인 신청 !관리자! 조회 -->
	<select id="getBizEvalList" resultMap="BizEvalAgreeChangeMap">
		SELECT
			e_agree_code
			, biz_id
			, store_code
			, e_agree_before
			, e_agree_after
			, e_apply_time
			, confirm_id
			, e_state_code
			, e_confirm_time
		FROM
			tb_member_eval_agree_change;
	</select>
	
	<!--구분구분구분구분구분구분-->	
	
	<!-- 소상공인 승인 상태, 승인자 아이디 변경 -->
	<update id="modifyBizConfirm">
		UPDATE tb_member_biz
		<trim prefix="SET" suffixOverrides=",">
			<if test="bizStatus != null and bizStatus != ''.toString()">
				biz_status = #{bizStatus},
			</if>
			<if test="confirmId != null and confirmId != ''.toString()">
				confirm_id = #{confirmId},
			</if>
			<if test="bizCompTime != null and bizCompTime != ''.toString()">
				biz_complete_time = NOW(),
			</if>
		</trim>
		WHERE
			biz_code = #{bizCode};
	</update>
	
	<!-- 소상공인 승인 신청 개인!조회(id) -->
	<select id="getMemberBizInfoById" resultMap="memberBizResultMap">
		SELECT 
			m.biz_code
			, m.member_id
			, m.biz_num
			, m.biz_file_att
			, m.biz_status
			, m.confirm_id
			, m.biz_re_time
			, m.biz_complete_time
			, s.state_code
			, s.main_state
			, s.state_name
		FROM
			tb_member_biz as m
			INNER JOIN
			tb_statement as s
			on
			m.biz_status = s.state_code
		WHERE
			member_id = #{memberId};
	</select>
	
	<!-- 소상공인 승인 신청 개인!조회(code) -->
	<select id="getMemberBizInfoByCode" resultMap="memberBizResultMap">
		SELECT 
			m.biz_code
			, m.member_id
			, m.biz_num
			, m.biz_file_att
			, m.biz_status
			, m.confirm_id
			, m.biz_re_time
			, m.biz_complete_time
			, s.state_code
			, s.main_state
			, s.state_name
		FROM
			tb_member_biz as m
			INNER JOIN
			tb_statement as s
			on
			m.biz_status = s.state_code
		WHERE
			biz_code = #{bizCode};
	</select>
	
	<!-- 소상공인 승인 신청 !!관리자가!!조회 -->
	<select id="getMemberBizList" resultMap="memberBizResultMap">
		SELECT 
			biz_code
			, m.member_id
			, m.biz_num
			, m.biz_file_att
			, m.biz_status
			, m.confirm_id
			, m.biz_re_time
			, m.biz_complete_time
			, s.state_code
			, s.main_state
			, s.state_name
		FROM
			tb_member_biz as m
			INNER JOIN
			tb_statement as s
			on
			m.biz_status = s.state_code;
	</select>
	
	<!-- 소상공인 승인코드 자동증가 -->
	<select id="getMemberBizCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'biz_001'
		   ELSE
		      CONCAT('biz_', LPAD(MAX(CAST(SUBSTRING(biz_code,5,3)AS DECIMAL)+1),3,0))
		   END AS bizCode
		FROM
		   tb_member_biz;
	</select>
	
	<!-- 소상공인 승인 신청 등록 -->
	<insert id="addBizConfirm">
		INSERT INTO tb_member_biz
			(biz_code
			, member_id
			, biz_num
			, biz_file_att
			, biz_status
			, confirm_id
			, biz_re_time
			, biz_complete_time
		)VALUES (
			#{bizCode}
			, #{memberId}
			, #{bizNum}
			, #{bizFileAtt}
			, #{bizStatus}
			, #{confirmId}
			, NOW()
			, NOW());
	</insert>
	
	<!-- 소비자 회원 추가정보 개인조회(레벨이랑 join) -->
	<select id="getMemberUserInfoById" resultMap="memberUserResultMap">
		SELECT 
			m.user_id
			, m.ms_code
			, m.user_order_total
			, m.user_point
			, m.user_evaluator
			, m.report_accu_score
			, s.ms_lev
			, s.ms_dis
			, s.ms_standard
			, l.user_like_code
			, l.like_id
			, l.user_like_key_1
			, l.user_like_key_2
			, l.user_like_key_3
			, l.user_unlike_key_1
			, l.user_unlike_key_2
			, l.user_unlike_key_3
			, d.ms_del_code
			, d.del_before_count
			, d.del_before_name
			, d.reset_time
		FROM 
			tb_member_user AS m
			INNER JOIN
			tb_membership_dis AS s
			ON
			m.ms_code = s.ms_code
			INNER JOIN
			tb_member_user_like AS l
			ON
			m.user_id = l.like_id
			INNER JOIN
			tb_membership_del AS d
			ON
			m.user_id = d.user_id
		WHERE
			m.user_id = #{userId};
	</select>
	
	<!-- 소비자 회원 추가정보 조회 -->
	<select id="getMemberUserList" parameterType="String" resultMap="memberUserResultMap">
		SELECT 
			m.user_id
			, m.ms_code
			, m.user_order_total
			, m.user_point
			, m.user_evaluator
			, m.report_accu_score
			, s.ms_lev
			, s.ms_dis
			, s.ms_standard
			, l.user_like_code
			, l.like_id
			, l.user_like_key_1
			, l.user_like_key_2
			, l.user_like_key_3
			, l.user_unlike_key_1
			, l.user_unlike_key_2
			, l.user_unlike_key_3
			, d.ms_del_code
			, d.del_before_count
			, d.del_before_name
			, d.reset_time
		FROM 
			tb_member_user AS m
			INNER JOIN
			tb_membership_dis AS s
			ON
			m.ms_code = s.ms_code
			INNER JOIN
			tb_member_user_like AS l
			ON
			m.user_id = l.like_id
			INNER JOIN
			tb_membership_del AS d
			ON
			m.user_id = d.user_id;
	</select>
	
	<!-- 마이페이지 내정보 수정 -->
	<update id="modifyMyInfo" parameterType="Member">
		UPDATE tb_member
		<trim prefix="SET" suffixOverrides=",">
			<if test="memberPw != null and memberPw != ''.toString()">
				member_pw = #{memberPw},
			</if>
			<if test="memberName != null and memberName != ''.toString()">
				member_name = #{memberName},
			</if>
			<if test="memberGender != null and memberGender != ''.toString()">
				member_gender = #{memberGender},
			</if>
			<if test="memberBirth != null and memberBirth != ''.toString()">
				member_birth = #{memberBirth},
			</if>
			<if test="memberPhone != null and memberPhone != ''.toString()">
				member_phone = #{memberPhone},
			</if>
			<if test="memberEmail != null and memberEmail != ''.toString()">
				member_email = #{memberEmail},
			</if>
		</trim>
		WHERE
			member_id = #{memberId};
	</update>
	
	<!-- 로그인, 내정보조회 -->
	<select id="getMemberInfoById" parameterType="String" resultMap="memberResultMap">
		SELECT 
			  member_id
			, member_pw
			, member_name
			, level_code
			, member_gender
			, member_birth
			, member_phone
			, member_email
		FROM 
			tb_member
		WHERE
			member_id = #{memberId};
	</select>
	
	<!-- 회원 전체 목록 조회 -->
	<select id="getMemberList" resultMap="memberResultMap">
		SELECT 
			  m.member_id
			, m.member_pw
			, m.member_name
			, m.level_code
			, m.member_gender
			, m.member_birth
			, m.member_phone
			, m.member_email
			, m.member_reg_time
			, lv.level_code
			, lv.level_name
			, l.login_num
			, l.last_login_time
			, l.last_logout_time
		FROM 
			tb_member AS m
			LEFT join
			tb_member_level AS lv
			on
			m.level_code = lv.level_code
			LEFT join
			tb_member_login AS l
			on
			m.member_id = l.member_id
		ORDER BY
			m.member_reg_time DESC;
	</select>
	
	<!-- 소비자 추가정보 등록 -->
	<insert id="addMember03">
		INSERT INTO tb_member_user
			(user_id
			, ms_code
			, user_order_total
			, user_point
			, user_evaluator
			, report_accu_score
		)VALUES (
			#{userId}
			, #{msCode}
			, #{userOrderTotal}
			, #{userPoint}
			, #{userEvaluator}
			, #{reportScore});
	</insert>
	
	<!-- 선호/비선호 선택한거 등록  -->
	<insert id="addMemberUserLike">
		INSERT INTO tb_member_user_like
			(user_like_code
			, like_id
			, user_like_key_1
			, user_like_key_2
			, user_like_key_3
			, user_unlike_key_1
			, user_unlike_key_2
			, user_unlike_key_3
		)VALUES (
			#{userLikeCode}
			, #{likeId}
			, #{userLikeKey1}
			, #{userLikeKey2}	
			, #{userLikeKey3}
			, #{userUnlikeKey1}
			, #{userUnlikeKey2}
			, #{userUnlikeKey3});
	</insert>
	
	<!-- 선호-비선호코드 자동증가 -->
	<select id="getUserLikeCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'us_like_001'
		   ELSE
		      CONCAT('us_like_', LPAD(MAX(CAST(SUBSTRING(user_like_code,9,3)AS DECIMAL)+1),3,0))
		   END AS userLikeCode
		FROM
		   tb_member_user_like;
	</select>
	
	<!-- 선호/비선호 선택 카테고리 리스트 불러오기 -->
	<select id="getFoodMainList" resultType="FoodMainCate">
		SELECT 
			main_cate_code		AS mainCateCode
		  , main_cate_name		AS mainCateName
		FROM 
			tb_food_main_cate;
	</select>

	<!-- 소비자, 소상공인 회원 등록 -->
	<insert id="addMember02">
		INSERT INTO tb_member
			(member_id
			, member_pw
			, member_name
			, level_code
			, member_gender
			, member_birth
			, member_phone
			, member_email
			, member_reg_time
		)VALUES (
			  #{memberId}
			, #{memberPw}
			, #{memberName}
			, #{levelCode}
			, #{memberGender}
			, #{memberBirth}
			, #{memberPhone}
			, #{memberEmail}
			, CURDATE());
	</insert>
	
	<!-- id 중복검사 -->
	<select id="idCheck" resultMap="memberResultMap">
		SELECT 
			member_id 
		FROM 
			tb_member
		WHERE
			member_id = #{memberId};
	</select>
</mapper>