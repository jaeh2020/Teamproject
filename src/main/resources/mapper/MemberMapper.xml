<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="amdn.anywhere.mapper.MemberMapper">
	<resultMap type="Member" id="memberResultMap">
		<result property="memberId" column="member_id"/>
		<result property="memberPw" column="member_pw"/>
		<result property="memberName" column="member_name"/>
		<result property="levelCode" column="level_code"/>
		<result property="memberGender" column="member_gender"/>
		<result property="memberBirth" column="member_birth"/>
		<result property="memberPhone" column="member_phone"/>
		<result property="memberEmail" column="member_email"/>
		<result property="memberRegTime" column="member_reg_time"/>
	</resultMap>
	
	<resultMap type="MemberUser" id="memberUserResultMap">
		<result property="userId" column="user_id"/>
		<result property="msCode" column="ms_code"/>
		<result property="userOrderTotal" column="user_order_total"/>
		<result property="userPoint" column="user_point"/>
		<result property="userEvaluator" column="user_evaluator"/>
		<result property="reportScore" column="report_accu_score"/>
	</resultMap>
	
	<!-- 소비자 회원 추가정보 개인조회 -->
	<select id="getMemberUserInfoById" resultMap="memberUserResultMap">
		SELECT 
			user_id
			, ms_code
			, user_order_total
			, user_point
			, user_evaluator
			, report_accu_score
		FROM 
			tb_member_user
		WHERE
			user_id = #{userId};
	</select>
	
	<!-- 소비자 회원 추가정보 조회 -->
	<select id="getMemberUserList" parameterType="String" resultMap="memberUserResultMap">
		SELECT 
			user_id
			, ms_code
			, user_order_total
			, user_point
			, user_evaluator
			, report_accu_score
		FROM 
			tb_member_user;
	</select>
	
	<!-- 마이페이지 내정보 수정 -->
	<update id="modifyMyInfo" parameterType="Member">
		UPDATE tb_member
		<trim prefix="SET" suffixOverrides=",">
			<if test="memberPw != null and memberPw != ''.toString()">
				member_pw = #{memberPw},
			</if>
			<if test="memberName != null and memberName != ''.toString()">
				member_name = #{memberName},
			</if>
			<if test="memberGender != null and memberGender != ''.toString()">
				member_gender = #{memberGender},
			</if>
			<if test="memberBirth != null and memberBirth != ''.toString()">
				member_birth = #{memberBirth},
			</if>
			<if test="memberPhone != null and memberPhone != ''.toString()">
				member_phone = #{memberPhone},
			</if>
			<if test="memberEmail != null and memberEmail != ''.toString()">
				member_email = #{memberEmail},
			</if>
		</trim>
		WHERE
			member_id = #{memberId};
	</update>
	
	<!-- 로그인, 내정보조회 -->
	<select id="getMemberInfoById" parameterType="String" resultMap="memberResultMap">
		SELECT 
			  member_id
			, member_pw
			, member_name
			, level_code
			, member_gender
			, member_birth
			, member_phone
			, member_email
		FROM 
			tb_member
		WHERE
			member_id = #{memberId};
	</select>
	
	<!-- 회원 전체 목록 조회 -->
	<select id="getMemberList" resultMap="memberResultMap">
		SELECT 
			member_id
			, member_pw
			, member_name
			, level_code
			, member_gender
			, member_birth
			, member_phone
			, member_email
			, member_reg_time
		FROM 
			tb_member;
	</select>
	
	<!-- 소비자 추가정보 등록 -->
	<insert id="addMember03">
		INSERT INTO tb_member_user
			(user_id
			, ms_code
			, user_order_total
			, user_point
			, user_evaluator
			, report_accu_score
		)VALUES (
			#{userId}
			, #{msCode}
			, #{userOrderTotal}
			, #{userPoint}
			, #{userEvaluator}
			, #{reportScore});
	</insert>
	
	<!-- 선호/비선호 선택한거 등록  -->
	<insert id="addMemberUserLike">
		INSERT INTO tb_member_user_like
			(user_like_code
			, member_id
			, user_like_key_1
			, user_like_key_2
			, user_like_key_3
			, user_unlike_key_1
			, user_unlike_key_2
			, user_unlike_key_3
		)VALUES (
			#{userLikeCode}
			, #{memberId}
			, #{userLikeKey1}
			, #{userLikeKey2}	
			, #{userLikeKey3}
			, #{userUnlikeKey1}
			, #{userUnlikeKey2}
			, #{userUnlikeKey3});
	</insert>
	
	<!-- 선호-비선호코드 자동증가 -->
	<select id="getUserLikeCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'us_like_001'
		   ELSE
		      CONCAT('us_like_', LPAD(MAX(CAST(SUBSTRING(user_like_code,9,3)AS DECIMAL)+1),3,0))
		   END AS userLikeCode
		FROM
		   tb_member_user_like;
	</select>
	
	<!-- 선호/비선호 선택 카테고리 리스트 불러오기 -->
	<select id="getFoodMainList" resultType="FoodMainCate">
		SELECT 
			main_cate_code		AS mainCateCode
		  , main_cate_name		AS mainCateName
		FROM 
			tb_food_main_cate;
	</select>

	<!-- 소비자, 소상공인 회원 등록 -->
	<insert id="addMember02">
		INSERT INTO tb_member
			(member_id
			, member_pw
			, member_name
			, level_code
			, member_gender
			, member_birth
			, member_phone
			, member_email
			, member_reg_time
		)VALUES (
			  #{memberId}
			, #{memberPw}
			, #{memberName}
			, #{levelCode}
			, #{memberGender}
			, #{memberBirth}
			, #{memberPhone}
			, #{memberEmail}
			, CURDATE());
	</insert>
	
	<!-- id 중복검사 -->
	<select id="idCheck" resultMap="memberResultMap">
		SELECT 
			member_id 
		FROM 
			tb_member
		WHERE
			member_id = #{memberId};
	</select>
</mapper>