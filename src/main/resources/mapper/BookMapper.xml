<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="amdn.anywhere.mapper.BookMapper">



<!-- 예약리스트 조회  -->
	<select id="getBookList" resultType="Book">
		SELECT 
			b_o_code			AS bookCode
			,store_code			AS storeCode
			,user_id			AS userId
			,book_user_name		AS bookUserName
			,book_user_phone	AS bookUserPhone
			,book_peo_num		AS bookPeoNum
			,book_sign_time		AS bookSignTime
			,book_comp_time		AS bookCompTime
			,book_call_agree	AS bookCallAgree
			,state_code			AS stateCode
			,book_pickup		AS bookPickup
		FROM 
			tb_book;
	</select>



<!-- 예약자정보입력 후 insert  -->
	<insert id="addBookOrder" parameterType="Order">
		INSERT INTO tb_order
			(o_code
			,b_o_code
			,store_code
			,o_count
			,menu_code
			,o_request
			,pay_gro_code
			,o_total_price
			,order_sign_time
			,order_comp_time
			,order_state_code
			,store_table_code
			,table_state_code
		)VALUES (
			   #{oCode}
			  ,#{bookCode}
			  ,#{storeCode}
			  ,#{oCount}
			  ,#{menuCode}
			  ,#{oRequest}
			  ,#{payGroCode}
			  ,#{oTotalPrice}
			  ,CURDATE()
			  ,null
			  ,#{orderStateCode}
			  ,#{storeTableCode}
			  ,#{tabelStateCode}
		);
	</insert>
	
	
	
<!-- 주문코드 자동증가 -->
	<select id="getNewOrderCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'o_001'
		   ELSE
		      CONCAT('o_', LPAD(MAX(CAST(SUBSTRING(o_code,3,3)AS DECIMAL)+1),3,0))
		   END AS oCode
		FROM
		   tb_order;
	</select>




<!-- 예약자정보 페이지에 상태코드 불러오기 -->
	<select id="getStateCode" parameterType="String" resultType="Statement">
		SELECT 
			state_code AS stateCode
			,main_state AS mainState
			,state_name AS stateName
		FROM 
			tb_statement
		WHERE
			main_state = '예약주문'
			and
			state_name = '접수대기';
	</select>




<!-- 주문정보 페이지에 메뉴리스트 불러오기 -->
	<select id="getMenuList" resultType="Menu">
		SELECT 
			menu_code AS menuCode
			,store_code AS storeCode
			,main_cate_code AS mainCateCode
			,menu_cate_code AS menuCateCode
			,menu_name AS menuName
			,menu_price AS menuPrice
			,menu_detail AS menuDetail
			,menu_using AS menuUsing
		FROM 
			tb_store_menu;
	</select>



<!-- 예약자정보 페이지에 매장명,매장코드 불러오기 -->
	<select id="getStoreInfo" parameterType="String" resultType="Store">
		SELECT 
			store_name AS storeName
			,store_code AS storeCode
		FROM 
			tb_store_info
		WHERE
			store_name = #{storeName};
	</select>



<!-- 예약자정보입력 후 insert  -->
	<insert id="addBookMember" parameterType="Book">
		INSERT INTO tb_book
			(b_o_code
			,store_code
			,user_id
			,book_user_name
			,book_user_phone
			,book_peo_num
			,book_sign_time
			,book_comp_time
			,book_call_agree
			,state_code
			,book_pickup
		)VALUES (
			   #{bookCode}
			  ,#{storeCode}
			  ,#{userId}
			  ,#{bookUserName}
			  ,#{bookUserPhone}
			  ,#{bookPeoNum}
			  ,CURDATE()
			  ,null
			  ,null
			  ,#{stateCode}
			  ,#{bookPickup}
		);
	</insert>


<!-- 예약코드 자동증가 -->
	<select id="getNewBookCode" resultType="String">
		SELECT
		   CASE
		   WHEN COUNT(1) = 0 THEN 'b_001'
		   ELSE
		      CONCAT('b_', LPAD(MAX(CAST(SUBSTRING(b_o_code,3,3)AS DECIMAL)+1),3,0))
		   END AS bookCode
		FROM
		   tb_book;
	</select>
	
	
<!-- 매장코드 조회 -->	
	<select id="getStoreCode"  parameterType="String" resultType="Store">
		SELECT 
			store_code
		FROM	
			tb_store_info
		WHERE 
			store_name = #{storeName};
	</select>


</mapper>