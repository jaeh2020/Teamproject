<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/default}">

<th:block layout:fragment="customTitle">
	<title th:text="${title}"></title>
	
<!-- css -->
<style type= "text/css">
	.card h1{
		text-align: center;
		padding: 10px;
	}
	.join{
		display:inline-block;
		margin: 0;
		padding: 0;
	}
	.join li{
		float:left; 
		margin: 0 35px 0 35px;
	}
	.col-md-4{
		margin-top: 100px;
		margin-bottom: 80px;
	}
	.list{
		display: block;
		margin-top: 40px;
		text-align: center;
	}
	.join li p span{
		display: block;
   		width: 24px;
    	margin: 0 auto 10px;
    	padding: 30px 0 3px;
    	border-bottom: 1px solid #999;
    	color: #505050;
	}
	li .on{
		color: #4B088A;
		font-weight: bold;
	}
	.form-group div{
		border: 1px solid #000;
	}
	.form-group .sub{
		display: block;
		font-weight: bold;
		margin-top: 20px;
	}
	#foodMainList{
		margin: 20px;
		
	}
	.form-button .btn {
		display : inline-block;
		width : 80px;
		text-align: center;
		margin-left: 20px;
	}
	.form-button{
		text-align: center;
	}
</style>
</th:block>


<!-- contents layout:fragment 정의 -->
<th:block layout:fragment="customContents">
	<div class="row justify-content-center">
		<div class="col-lg-3"></div>
		<!-- 추/비 수정 -->		
		<div class="col-lg-6 ">
			<div class="card card-outline-primary">
			<input type="hidden" id="SID" th:value="${session.SID}">
	            <div class="card-header">
	                <h4 class="m-b-0 text-white">추천 / 비추천 카테고리 수정</h4>
	            </div>
	            <div class="card-body">	            
					<div class="login-form justify-content-center">
                                <form th:action="@{/member/myPage}" method="post">
                                	<!-- hidden -->   
                                	<input type="hidden" name="userLikeCode" id="userLikeCode" th:value="${memberUser.memberUserLike.userLikeCode}">
                                	<input type="hidden" name="likeId" id="likeId" th:value="${memberUser.userId}">
                                	
									
                                    <div class="form-group">
	                                    <label class="sub">선호하는 음식 </label><label>( ※ 최대 3개까지만 선택 가능합니다.)</label> 
	                                    <div>
	                                   		<label id="foodMainList" th:each="l : ${foodMainList}">                                  		
	                                   			<input type="checkbox" name="like" th:id="${l.mainCateName}" th:value="${l.mainCateName}">
	                                   				[[${l.mainCateName}]]
	                                   		</label>
	                                    </div>		
	                                    <label class="sub">비선호하는 음식</label><label>( ※ 최대 3개까지만 선택 가능합니다.)</label> 
	                                    <div>
	                                   		<label id="foodMainList" th:each="l : ${foodMainList}">                                  		
	                                   			<input type="checkbox" name="unlike" th:value="${l.mainCateName}">
	                                   				[[${l.mainCateName}]]
	                                   		</label>
	                                    </div>		
                                    </div>
                                    <div class="form-button">
	                                  	<a th:href="@{/member/myPage(userId=${memberUser.userId})}" class="btn btn-inverse btn-flat m-b-30 m-t-30">이전</a>
	                                    <a th:href="@{/member/myPage(userId=${memberUser.userId})}">
		                                 	<button type="button" class="btn btn-success btn-flat m-b-30 m-t-30">수정하기</button>
		                                </a>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3"></div>
            </div>                 
</th:block>

<th:block layout:fragment="customJsLib">
	<script type="text/javascript">
		$(function(){
			
			//페이지 로딩 시 db에서 값 가져와서 체크박스에 체크하기
			var userId = $('#SID').val();
			console.log(userId)
			
			var request =  $.ajax({
				  url: "/likeList", //요청 주소
				  method: "GET", //요청 방식
				  data: { userId : userId },
				  dataType: "json" //받아올 포맷방식
			});	
			request.done(function(data){
				
				console.log(data);
				var like1 = data.memberUserLike.userLikeKey1;
				var like2 = data.memberUserLike.userLikeKey2;
				var like3 = data.memberUserLike.userLikeKey3;
				var unlike1 = data.memberUserLike.userUnlikeKey1;
				var unlike2 = data.memberUserLike.userUnlikeKey2;
				var unlike3 = data.memberUserLike.userUnlikeKey3;

				var dbLikeArr = [];
				dbLikeArr.push(like1,like2,like3);
				var dbUnlikeArr = [];
				dbUnlikeArr.push(unlike1,unlike2,unlike3);
				
				console.log(dbLikeArr,'dbLikeArr');
				console.log(dbUnlikeArr,'dbUnlikeArr');
				//like 배열 체크
				for(var i=0; i < dbLikeArr.length; i++){
				  $('input:checkbox[name=like]').each(function(){
				    if(this.value == dbLikeArr[i]){
				   		 this.checked = true;
				    }
				  });
				}
				//unlike 배열 체크
				for(var i=0; i < dbUnlikeArr.length; i++){
				  $('input:checkbox[name=unlike]').each(function(){
				    if(this.value == dbUnlikeArr[i]){
				   		 this.checked = true;
				    }
				  });
				}	
				
			});
			//응답 실패
			request.fail(function(request,status,error){
		        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
		    });
			

			
			//3개 이상 선택 시 경고창
			$('input:checkbox[name=like]').on('click', function(){				
				var cnt = $('input:checkbox[name=like]:checked').length;
				if(cnt > 3){
					$(this).prop("checked", false);
					alert("3개까지만 선택이 가능합니다.");
				}				
			});
			$('input:checkbox[name=unlike]').on('click', function(){		
				var cnt = $('input:checkbox[name=unlike]:checked').length;
				if(cnt > 3){
					$(this).prop("checked", false);
					alert("3개까지만 선택이 가능합니다.");
				}							
			});
			//체크 된 값 ajax로 보내서 수정
			$('.btn-success').on('click', function(){
				var userLikeCode = $("#userLikeCode").val();
				var likeId = $("#likeId").val();
				console.log(userLikeCode,likeId)
				//선호도
				var likeArr = [];
				$('input:checkbox[name=like]').each(function() {
		     		if(this.checked){//checked 처리된 항목의 값
		     			likeArr.push(this.value);
		      		}
				});
				//비선호도
				var unlikeArr = [];
				$('input:checkbox[name=unlike]').each(function() {
		     		if(this.checked){//checked 처리된 항목의 값
		     			unlikeArr.push(this.value);
		      		}
				});		
				//ajax
				var allData = {"userLikeCode":userLikeCode, "likeId":likeId, "likeArr":likeArr, "unlikeArr":unlikeArr}
				console.log(allData,'allData')
				
				  var request = $.ajax({
				  url: "/modifyUserLike", //요청 주소
				  method: "GET", //요청 방식
				  data: allData, //전달 할 파라미터
				  dataType: "html" //받아 올 포맷방식
				});
				//응답이 완료 되었을 경우 실행
				request.done(function( data ) {
				  console.log(data,"data");
				});
				request.fail(function(request,status,error){
			        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
			    });
				
			});

		});		
	</script> 	
</th:block>
</body>
</html>