<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/default}">

<th:block layout:fragment="customTitle">
	<title th:text="${title}"></title>
	
<!-- css -->
<style type= "text/css">
	.btn{
		background-color: #5EA978;
		color: #fff;
		width: 70px;
	}
</style>
</th:block>


<!-- contents layout:fragment 정의 -->
<th:block layout:fragment="customContents">

	
<div class="row">
	<input type="hidden" id="SID" th:value="${session.SID}">
		<div class="col-lg-12 ">
			<div class="card card-outline-primary">
	            <div class="card-header">
	                <h4 class="m-b-0 text-white">평가 동의 목록</h4>
	            </div>
	            <div class="card-body">
	            <div class="table-responsive m-t-40">
                	<table id="myTable" class="table table-bordered table-striped">
                    	<thead>
                            <tr>
                                <th>평가동의 변경코드</th>
                                <th>소상공인 아이디</th>
                                <th>매장코드</th>
                                <th>평가동의 변경 전</th>
                                <th>평가동의 변경 후</th>
                                <th>변경 신청 일시</th>
                                <th data-orderable="false">승인</th>
                                <th>승인 상태</th>
                                <th>승인 완료 일시</th>
                            </tr>
                        </thead>
						<tbody th:id="bizEvalList">
		                    <tr th:each="l : ${bizEvalList}">
		                    	<td th:text="${l.eAgreeCode}" class="eAgreeCode"></td>
		                    	<td th:text="${l.bizId}"></td> 
		                    	<td th:text="${l.storeCode}"></td> 
		                    	<td th:text="${l.eAgreeBefore}"></td> 
		                    	<td th:text="${l.eAgreeAfter}"></td> 
		                    	<td th:text="${l.eAgreeTime}"></td> 
		                    	<td class="btn btn-pink btn-sm">승인</td>
		                    	<td th:text="${l.eStateCode}" class="eStateCode"></td> 
		                    	<td th:text="${l.eConfirmTime}"></td>
		                    </tr>
	               		</tbody>
	            	</table>
	        	</div>
			</div>
		</div>
	</div>
</div>
</th:block>


<th:block layout:fragment="customJsLib">
	<script th:src="@{/js/lib/sweetalert/sweetalert.min.js}"></script>
	<script th:src="@{/js/lib/datatables/datatables.min.js}"></script>
    <script th:src="@{/js/lib/datatables/cdn.datatables.net/buttons/1.2.2/js/dataTables.buttons.min.js}"></script>
    <script th:src="@{/js/lib/datatables/cdn.datatables.net/buttons/1.2.2/js/buttons.flash.min.js}"></script>
    <script th:src="@{/js/lib/datatables/datatables-init.js}"></script>
	<script type="text/javascript">
		$(function(){
		 	$('.btn-pink').on('click',function(){		 		
		 		var eAgreeCode = $(this).parent().find('.eAgreeCode').text();
		 		sessionStorage.setItem("eAgreeCode", eAgreeCode);
		 		var eStateCode = $(this).parent().find('.eStateCode').text();
		 		
		 		if(eStateCode == '승인완료'){
		 			alert('이미 승인이 완료된 신청건 입니다.');
		 		}else if(eStateCode == '승인거절'){
		 			alert('이미 승인이 거절된 신청건 입니다.');
		 		}else{
		 			
					swal({
				            title: "승인 하시겠습니까?",
				            text: "승인 후에는 수정이 불가합니다.",
				            type: "info",
				            showCancelButton: true,
				            confirmButtonColor: "#A0CF8F",
				            confirmButtonText: "승인완료",
				            cancelButtonText: "승인거절",
				            closeOnConfirm: true,
				            closeOnCancel: true
				        },
				        //승인 눌렀을 때
				        function(isConfirm){
				            if (isConfirm) {
				            	var memberId = $('#SID').val();
				            	var eAgreeCode = sessionStorage.getItem("eAgreeCode");
								var eStateCode = "승인완료";
					            
					            var request = $.ajax({
					    			  url: "/modifyBizEvalConfirm", //요청 주소
					    			  method: "GET", //요청 방식
					    			  data: {"memberId" : memberId, "eAgreeCode" : eAgreeCode, "eStateCode":eStateCode}, //전달 할 파라미터
					    			  dataType: "html" //받아 올 포맷방식
				  				});
					          //응답이 완료 되었을 경우 실행
								request.done(function( data ) {
								  console.log(data,"data");
								  location.reload();
								});
					          	//응답 실패
								request.fail(function(request,status,error){
							        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
							    });
				            }
				            else {
				            	var memberId = $('#SID').val();
				            	var eAgreeCode = sessionStorage.getItem("eAgreeCode");
								var eStateCode = "승인거절";
					            
								var request = $.ajax({
					    			  url: "/modifyBizEvalConfirm", //요청 주소
					    			  method: "GET", //요청 방식
					    			  data: {"memberId" : memberId, "eAgreeCode" : eAgreeCode, "eStateCode":eStateCode}, //전달 할 파라미터
					    			  dataType: "html" //받아 올 포맷방식
				  				});
					          //응답이 완료 되었을 경우 실행
								request.done(function( data ) {
								  console.log(data,"data");
								  location.reload();
								});
					          	//응답 실패
								request.fail(function(request,status,error){
							        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
							    });
				            }
				        }); 	
		 		}
		 		
			}); 
			
		})
	</script>
</th:block>
</html>