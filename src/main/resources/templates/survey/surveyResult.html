<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/default}">
<!-- 사용자 지정 Css -->	  
<th:block layout:fragment="customCss">
	<style type="text/css">

	</style>
</th:block>	
 	<!-- 사용자 지정 Js -->
<th:block layout:fragment="customJs">
	<!-- Echart -->
    <script th:src="@{/js/lib/echart/echarts.js}"></script>
    <!-- <script th:src="@{/js/lib/echart/echarts-init.js}"></script> -->	
</th:block>
<th:block layout:fragment="customTitle">
	<title th:text="${title}"></title>
</th:block>

<!-- contents layout:fragment 정의 -->
<th:block layout:fragment="customContents">
	<div class="row">
		<div class="col-md-12">
			<div class="card ">
		        <div class="card-body">
					<div class="form-group row">
						<label class="col-lg-4 col-form-label" for="storeCode">매장을 선택해주세요 <span class="text-danger">*</span></label>
						<div class="col-lg-7">
							<select class="form-control" id="storeCode" name="storeCode">
								<option value=""> : : : 매장 목록  : : : </option>
								<option th:each="s : ${storeList}" th:text="${s.storeName}" th:value="${s.storeCode}"></option>
							</select>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-lg-4 col-form-label" for="storeCode">진행된 설문조사 <span class="text-danger">*</span></label>
						<div class="col-lg-7">
							<select class="form-control" id="surveyCode" name="surveyCode">
								<option value=""> : : : 설문 목록  : : : </option>
							</select>
						</div>
					</div>
					<div id="default"></div>
					 <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist" id="tabList">
                        <li class="nav-item"> <a class="nav-link active" data-toggle="tab" href="#home" role="tab"><span class="hidden-sm-up"><i class="ti-home"></i></span> <span class="hidden-xs-down">Home</span></a> </li>
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content tabcontent-border" id="tabCont">
                        
                    </div>
		        </div>
		    </div>
	    </div>
	</div>
</th:block>
<th:block layout:fragment="customJsLib">
	<script type="text/javascript">
	//pie 차트에 필요한 데이터 가져오는 ajax
	$(function(){
		$('#storeCode').on("change", function(){
				var storeCode = $('#storeCode option:selected');
				console.log(storeCode);
			
			 var request = $.ajax({
					url: "/survey/getSurveyList", //요청 주소
					method: "GET", //요청 방식
					data: { storeCode : storeCode.val() },
					dataType: "json" //받아올 포맷방식
					});	 
				 request.done(function(data){
					 console.log(data);
					var option = '<option value=""> : : :  설문 목록   : : : </option>';
					 for(var i=0; i<data.length; i++){
						 option += '<option value= ' + data[i].createCode + '>' + data[i].recruitTasterByBiz.surveyTitle + '</option>';
					 }
						$('#surveyCode').html(option);					 
				 });
				 request.fail(function( jqXHR, textStatus){
						alert( "Request failed: " + textStatus );
					}); 
			});
		});
	$(function(){
		$('#surveyCode').on("change", function(){
			var surveyCode = $('#surveyCode option:selected');
			console.log(surveyCode.val());
			
			var request = $.ajax({
					url: "/survey/getSurveyResult", //요청 주소
					method: "GET", //요청 방식
					data: { surveyCode : surveyCode.val() },
					dataType: "json" //받아올 포맷방식
					});
			var tabHtml = '';
			var tabCtnt = '';
			
			 request.done(function(data){
				 console.log(data);
				 
				 var qCate = '';
				 for(var i=0; i < data.surveyResult.length ; i++){
					 if(qCate != data.surveyResult[i].qCateCode){
						 tabHtml += '<li class="nav-item">';
						 tabHtml +='	<a class="nav-link" data-toggle="tab" href="#'+ i +'" role="tab">';
						 tabHtml +='		<span class="hidden-sm-up">';
						 tabHtml +='			<i class="ti-home"></i>';
						 tabHtml +='		</span>';
						 tabHtml +='		<span class="hidden-xs-down">'+ data.surveyResult[i].qCateName +'</span>';
						 tabHtml +='	</a>';
						 tabHtml +='</li>';
						
						 tabCtnt += '<div class="tab-pane" id="'+ i + '" role="tabpanel">';
						 tabCtnt +='	<div class="p-20">';
						 tabCtnt +='		<div class="card-title">';
						 tabCtnt +='			<h4> ' + data.surveyResult[i].qCateName+ ' </h4>';
						 tabCtnt +='		</div>';
						 tabCtnt +='		<div class="card-content">';
						 tabCtnt +='			<div  style="height: 370px"></div>';
						 tabCtnt +='		</div>';
						 tabCtnt +='  	</div>';	
						 tabCtnt +='</div>';
						  
						 $('#tabList').html(tabHtml);
						 $('#tabCont').html(tabCtnt);
					 }
						qCate = data.surveyResult[i].qCateCode;
						console.log(qCate);
				 }
				 var defaultInfo ='';
				 defaultInfo += '<div class="tab-pane active" id="'+ i + '" role="tabpanel">';
				 defaultInfo +='	<div class="p-20">';
				 defaultInfo +='		<div class="card-title">';
				 defaultInfo +='			<h4>참여인원: ' + data.surveyResult[0].numOfParti+ '명</h4>';
				 defaultInfo +='		</div>';
				 defaultInfo +='		<div class="card-content">';
				 defaultInfo +='			<div id="age-Pie" style="height: 370px"></div>';
				 defaultInfo +='		</div>';
				 defaultInfo +='  	</div>';	
				 defaultInfo +='</div>'; 
				 
				 $('#default').html(defaultInfo);
				 
				 var age10 = data.age10; 	
				 var age20 = data.age20; 	
				 var age30 = data.age30; 	
				 var age40 = data.age40; 	
				 var age50 = data.age50;
		
				 	var dom = document.getElementById("age-Pie");
				    var bpChart = echarts.init(dom);

				    var app = {};
				    option = null;
				    option = {
				        color: ['#62549a','#4aa9e9', '#ff6c60','#eac459', '#25c3b2' ],
				        tooltip : {
				            trigger: 'item',
				            formatter: '{a} <br/>{b} : {c} ({d}%)'
				        },
				        legend: {
				            orient : 'vertical',
				            x : 'left',
				            data:['10대','20대','30대','40대','50대 이상']
				        },
				        calculable : true,
				        series : [
				            {
				                name:'Source',
				                type:'pie',
				                radius : '55%',
				                center: ['50%', '60%'],
				                data:[
				                    {value: age10, name:'10대'},
				                    {value: age20, name:'20대'},
				                    {value: age30, name:'30대'},
				                    {value: age40, name:'40대'},
				                    {value: age50, name:'50대 이상'}
				                ]
				            }
				        ]
				    };

				    if (option && typeof option === "object") {
				        bpChart.setOption(option, false);
				    }
				 
			});
			 
				
			 request.fail(function( jqXHR, textStatus){
					alert( "Request failed: " + textStatus );
				}); 
		});
		
	});
	

	</script>
</th:block>
</html>